<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quiz • MCQ Diagnoser</title>
  <link rel="stylesheet" href="/style.css" />
</head>

<body>
  <!-- Glow background (same as index/admin) -->
  <div class="bg">
    <div class="glow g1"></div>
    <div class="glow g2"></div>
    <div class="glow g3"></div>
    <div class="noise"></div>
  </div>

  <main class="container">
    <!-- Top bar -->
    <header class="topbar">
      <div class="brand">
        <div class="logo">Q</div>
        <div>
          <div class="title">MCQ Diagnoser</div>
          <div class="subtitle">Choose an answer • Next • Finish</div>
        </div>
      </div>

      <div class="pill">
        <span class="dot"></span>
        <span id="who">Loading…</span>
      </div>
    </header>

    <!-- Controls -->
    <div class="card glass" style="margin-bottom:16px;">
      <div class="actions" style="padding:16px 20px;">
        <button class="btn ghost" id="reloadBtn" type="button">Reload Bank</button>
        <button class="btn ghost" id="homeBtn" type="button">Home</button>
        <button class="btn" id="logoutBtn" type="button" style="background:#b92b2b;color:white;">Logout</button>
        <span class="status" id="status" style="margin-left:auto;"></span>
      </div>
    </div>

    <!-- Quiz card -->
    <section class="card glass">
      <div class="cardHead">
        <h2 id="progressTitle">Question</h2>
        <p id="metaLine">Loading…</p>
      </div>

      <div style="padding: 0 20px 20px;">
        <div id="questionText" style="font-size:20px;font-weight:850;margin:12px 0 14px;">
          Loading…
        </div>

        <div id="choices"></div>

        <div class="actions" style="padding:14px 0 0;">
          <button class="btn primary" id="nextBtn" type="button">Next</button>
          <span id="hint" style="color:rgba(255,255,255,.75);font-size:13px;"></span>
        </div>
      </div>
    </section>

    <footer class="footer">
      <span>Yellow / Black • Glass UI • Vercel + Supabase</span>
    </footer>
  </main>

  <script type="module">
    const whoEl = document.getElementById("who");
    const statusEl = document.getElementById("status");
    const progressTitle = document.getElementById("progressTitle");
    const metaLine = document.getElementById("metaLine");
    const questionText = document.getElementById("questionText");
    const choicesEl = document.getElementById("choices");
    const hintEl = document.getElementById("hint");
    const nextBtn = document.getElementById("nextBtn");

    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role") || "user";
    const username = localStorage.getItem("username") || "";

    let bank = [];
    let idx = 0;
    let selected = null;

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function guard(){
      if (!token){
        alert("Please login first.");
        location.href = "/";
        return false;
      }
      whoEl.textContent = username ? `${username} (${role})` : "Logged in";
      return true;
    }

    function logout(){
      localStorage.removeItem("token");
      localStorage.removeItem("role");
      localStorage.removeItem("username");
      location.href = "/";
    }

    async function fetchBank(){
      setStatus("Loading…");
      const res = await fetch("/api/bank", {
        headers: { Authorization: "Bearer " + token }
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = []; }

      if (!res.ok){
        setStatus("Error: " + (data?.error || ("HTTP " + res.status)));
        return [];
      }

      setStatus("Loaded ✅");
      return Array.isArray(data) ? data : [];
    }

    function render(){
      hintEl.textContent = "";
      selected = null;

      if (!bank.length){
        progressTitle.textContent = "No questions";
        metaLine.textContent = "Add questions in Supabase (admin).";
        questionText.textContent = "No questions found.";
        choicesEl.innerHTML = "";
        nextBtn.disabled = true;
        return;
      }

      const q = bank[idx];
      progressTitle.textContent = `Question ${idx + 1} / ${bank.length}`;
      metaLine.textContent = `Topic: ${q.topic || "-"} • Difficulty: ${q.difficulty || "-"}`;
      questionText.textContent = q.question || "(No question text)";

      const choices = Array.isArray(q.choices) ? q.choices : [];
      choicesEl.innerHTML = choices.map((c, i) => `
        <label class="choiceRow">
          <input type="radio" name="ans" value="${i}">
          <div class="choiceText">${escapeHtml(c)}</div>
        </label>
      `).join("");

      // bind selection
      choicesEl.querySelectorAll('input[name="ans"]').forEach((radio) => {
        radio.addEventListener("change", (e) => {
          selected = Number(e.target.value);
        });
      });

      nextBtn.disabled = false;
    }

    function next(){
      if (selected === null){
        hintEl.textContent = "Choose an answer first.";
        return;
      }

      idx++;
      if (idx >= bank.length){
        progressTitle.textContent = "✅ Finished";
        metaLine.textContent = "";
        questionText.textContent = "You reached the end of the question bank.";
        choicesEl.innerHTML = "";
        nextBtn.disabled = true;
        hintEl.textContent = "";
        return;
      }
      render();
    }

    document.getElementById("logoutBtn").onclick = logout;
    document.getElementById("reloadBtn").onclick = async () => {
      bank = await fetchBank();
      idx = 0;
      render();
    };
    document.getElementById("homeBtn").onclick = () => location.href = "/";
    nextBtn.onclick = next;

    (async function init(){
      if (!guard()) return;
      bank = await fetchBank();
      idx = 0;
      render();
    })();
  </script>
</body>
</html>
